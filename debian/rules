#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1
export DPKG_GENSYMBOLS_CHECK_LEVEL=4

# Try forcing quilt to apply the patches
DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH)

override_dh_quilt_patch:
	dh_quilt_patch
	if test -r debian/patches/series.$(DEB_HOST_ARCH); then \
		pc=".pc.$(DEB_HOST_ARCH)"; \
		test -d "$(CURDIR)/$$pc" || mkdir "$(CURDIR)/$$pc"; \
		cp debian/patches/series.$(DEB_HOST_ARCH) $(CURDIR)/$$pc/series; \
		cd $(CURDIR); \
		QUILT_PC="$$pc" quilt upgrade || true; \
		QUILT_PC="$$pc" QUILT_PATCHES="debian/patches/" quilt push -a || true; \
	fi; \

override_dh_quilt_unpatch:
	if test -r debian/patches/series.$(DEB_HOST_ARCH); then \
		pc=".pc.$(DEB_HOST_ARCH)"; \
		cd $(CURDIR); \
		QUILT_PC="$$pc" QUILT_PATCHES="debian/patches/" quilt pop -a || true; \
	fi; \
	dh_quilt_unpatch

override_dh_auto_configure:
	dh_auto_configure -- --enable-gtk-doc

override_dh_install:
	# install the python3 gir override file as well
	PYTHON=python3 ./configure --prefix=/usr
	cd pygobject/ && DESTDIR=../debian/tmp make install && cd ..
	rm debian/tmp/usr/lib/*/*.la
	rm debian/tmp/usr/lib/python*/dist-packages/gi/overrides/*.pyc
	rm debian/tmp/usr/lib/python*/dist-packages/gi/overrides/*.pyo
	rm -rf debian/tmp/usr/lib/python3/dist-packages/gi/overrides/__pycache__/
	rm debian/tmp/usr/share/backup-framework/applications/accounts.conf
	# Remove the installed tests
	rm -rf debian/tmp/usr/share/libaccounts-glib/testdata
	rm -rf debian/tmp/usr/lib/*/libaccounts-glib
	dh_install --fail-missing
	dh_python2 -pgir1.2-accounts-1.0

override_dh_autoreconf:
	NOCONFIGURE=1 dh_autoreconf ./autogen.sh

override_dh_auto_test:
	# Tests often fail in Jenkins for timeout reasons; therefore, increase
	# the timeout value
	CK_TIMEOUT_MULTIPLIER=2 dh_auto_test

%:
	dh $@ --with autoreconf,python2
